---
title: "Analyze MeadoWatch Data"
author: "Janneke Hille Ris Lambers, Aji John, Meera Sethi, Elli Theobald"
date: "Updated 12/17/2020"
output: html_document
---

#Setup for R script and R markdown
1. Load all libraries
2. Specify string behavior
3. Load packages (should we add all packages here?)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
library(tidyverse)
library(leaflet)
library(lubridate)
library(boot)
library(readr) 
```


#Read in clean data, define wildflower community
This chunk of code defines the wildflower community and subsets the data to only include these species. Specifically:

1. Specify which flowering species to include. For reference:
   A. Reflection Lakes species include: c("ANOC", "CAPA", "ERMO", "ERPE", "LIGR", "LUAR", "MIAL", "PEBR", "POBI", "VASI")
   B. Glacier Basin species include: c("ANAR", "ARLA", "ASLE", "CAMI", "ERGR", "LICA", "LUAR", "MEPA", "PEBR", "POBI", "VASI")
   ++Note that LICA was mistaken for ANAR early on, so there is limited data from both species. MEPA isn't strictly a meadow species, and MIAL is rare and of all the species least likely to occur on both trails. Recommended species therefore:
c("ANOC", "ARLA", "ASLE", "CAMI", "CAPA", "ERMO", "ERPE", "LIGR", "LUAR", "PEBR", "POBI", "VASI")

2. Create PhenoSite_Focal - data set with just species of interest

3. From this, *nspp* (number of species) and *nyears* (number of years) are defined, which are used in for loops

```{r}
# read in maximum likelihood functions
source("./HRL_phenology_functions.R")

# Read in clean dataset; merge with SDD data
PhenoSite_0 <- read.csv("data/PhenoSite_Clean.csv", header=TRUE)
SDDdat_0 <- read.csv("data/MW_SDDall.csv", header=TRUE)

# Create new SDD - observed when present, predicted when not
SDDfin <- SDDdat_0$SDD
# This substitutes in predicted SDD where sensors failed = NA
SDDfin[is.na(SDDdat_0$SDD)==TRUE] <- 
  round(SDDdat_0$predSDD[is.na(SDDdat_0$SDD)==TRUE],0)
# this removes unwanted columns, including SDD and pred SDD
SDDdat <- subset(SDDdat_0, select=-c(Site_Num, Site_Loc, calibration,
                                     snow_appearance_date, snow_disappearance_date,
                                     snow_cover_duration, minimum_soil_temp, SDD,
                                     notes,predSDD))
# This adds SDDfin back to data frame as SDD
SDDdat$SDD <- SDDfin

# Merge SDD and Pheno data
PhenoSite <- merge(PhenoSite_0,SDDdat, 
                   by=c("Year", "Site_Code", "Transect"))

# Define the wildflower community: which species to include
species <- c("ANOC", "ARLA", "ASLE", "CAMI", "CAPA", "ERMO", "ERGR", "ERPE",
             "LIGR", "LUAR", "PEBR", "POBI", "VASI")

# Create PhenoSite_Focal - data set with just species of interest
specieskeep <- PhenoSite$Species %in% species
PhenoSite_Focal <- PhenoSite[specieskeep,]

# Determine how many years of data, how many species, etc
yrs <- unique(PhenoSite_Focal$Year)
nyrs <- length(yrs)
nspp <- length(species)

```


#Fit phenology model for all species data, using second model
This code fits a predictive phenology model to all observations of flowering for a particular species (function *curvefit_allplot*), for the same flowering community as defined above. So, this code chunk expects that the data frame *PhenoSite_Focal*, the vector *species*, and the objects *nspp*, *totobs* and *totyesobs* have been defined. Note that this takes a bit of time to run (5ish minutes). The code does the following:

1. Subset data for a particular species.

2. For each species, use a for loop to assemble year-plot specific data for the species in question. This requires extracting year-plot specific data adding three no flowering observations before snowmelt (as was done for model fitting for individual year-plot-species data), and creating variables *days* (vector of DOY for all plots included), *phenophase* (vector of 1's and 0's observed), *SDD* (snow disappearance date at each plot for the observation in question) and *trlyr* which trail / year combo the observation came from (this is for fitting range, max parameters).

3. Fit the maximum likelihood model (defined by *curvefit_allplot* above) to the data. This requires setting initial parameters first - which was done by fitting the relationship between peak flowering and SDD from year-plot-species specific data (in *pars_sppltsp*), and taking the average range and duration values for those same model fits.

4. Saves the parameters to *pars_spp_peak*, *pars_spp_range*, *pars_spp_max*
    + *pars_spp_peak* per-species slope / intercept relates SDD to peak
    + *pars_spp_range* includes the year / trail specific range parameters
    + *pars_spp_max* includes the year / trail specific max parameters 
    
5. Also saves the AIC values to aics_sp

6. After the for loop, turns *pars_spp* objects into data framed, views it

7. Write *pars_spp_peak*, *pars_spp_range*, *pars_spp_max* as .csv files to the data folder.

```{r}
#define where to save output
pars_spp_peak <- c() #save peak parameters for per species fit
pars_spp_range <- c() #save range parameters for per species fit
pars_spp_max <- c() #save max parameters for per species fit
aics_sp <-c() #save AIC of overall model 
pars_cor <- c()

#Read in per plot model fits, to use for initiatl parameters
pars_yrpltsp <- read.csv("data/PerPlotCurves.csv", header=TRUE) 


##Now nested for loops to fit curves for all years, species, plots
for(i in 1:nspp){ #loop for each species, to assemble data
  #extract data for that year
  PhenoSite_Species <- PhenoSite_Focal[PhenoSite_Focal$Species==species[i],]
  
  #assemble data - need to add zeros before SDD, define trail year combos
  yrplt <- paste(PhenoSite_Species$Year, PhenoSite_Species$Site_Code, sep="")
  yrplts <- unique(yrplt)
  trailyear <- unique(paste(substr(yrplts,5,6),substr(yrplts,1,4),sep=""))
  trailyear <- trailyear[order(trailyear)]
  ntrlyr <- length(trailyear)
  trlyr <- c()
  days <- c()
  phenophase <- c()
  SDD <- c()
  
  #Now go through each unique year - plot combination per species
  for(j in 1:length(yrplts)){
     PhenoSite_YearPlotSpecies <- PhenoSite_Species[yrplt[]==yrplts[j],]
     tmpdays <- PhenoSite_YearPlotSpecies$DOY #explanatory variable: DOY 
     tmpphenophase <- PhenoSite_YearPlotSpecies$Flower #yes / no flowers
     tmpSDD <- PhenoSite_YearPlotSpecies$SDD
    
     #remove days when no observations were made; NA in phenophase
     tmpdays <- tmpdays[is.na(tmpphenophase)==FALSE]
     tmpSDD <- tmpSDD[is.na(tmpphenophase)==FALSE]
     tmpphenophase <- tmpphenophase[is.na(tmpphenophase)==FALSE]
     
     #Add observations of no flowering 3 weeks prior to snowmelt
     SDDplt <- min(tmpSDD)
     tmpdays <- c(SDDplt-21, SDDplt-14, SDDplt-7,tmpdays)
     tmpphenophase <- c(0,0,0,tmpphenophase)
     tmpSDD <- c(tmpSDD[1:3],tmpSDD)
    
     #determine which trail year combo
     whichtrlyr <- paste(substr(PhenoSite_YearPlotSpecies$Site_Code[1],1,2),
                                PhenoSite_YearPlotSpecies$Year[1], sep="")
     tmptrlyr <- rep(which(whichtrlyr==trailyear[]),times=length(tmpdays))
     #now append to days, phenophase,trlyear
     days <- c(days, tmpdays)
     phenophase <- c(phenophase, tmpphenophase)
     SDD <- c(SDD, tmpSDD)
     trlyr <- c(trlyr, tmptrlyr)
  }
  #now fit curvefit_all plot model - optim as function of SDD
  
  #first use individual year-plot-species to come up with starting points
  #slope & intercept for SDD vs optim
  pars_yrpltspsp <- pars_yrpltsp[pars_yrpltsp$species==species[i],]
  lmtest <- lm(pars_yrpltspsp$peak~pars_yrpltspsp$SDD)
  optimcoef <- unlist(coef(lmtest))
  #optimcoef <- c(0,1)
  spdur <- median(pars_yrpltsp$duration[pars_yrpltsp$species==species[i]])
  spmx <- median(pars_yrpltsp$max[pars_yrpltsp$species==species[i]])

  #specify initial parameters (note, optim can be fussy)
  param <- c(optimcoef, rep(spdur, times=ntrlyr), rep(spmx, times=ntrlyr))
  modelsnowmod <- optim(param, curvefit_allplot, control = list(maxit = 50000)) #,
                        #method = "SANN"
                        #method = "BFGS")

  
  if(modelsnowmod$convergence == 1){print(paste(species[i],"-issues",sep=""))}

  #Determine which years / trails (for plotting, saving)
  trails <- "both"
  if(length(unique(substr(trailyear,1,2)))==1){
    if(unique(substr(trailyear,1,2))=="RL"){trails <- "Reflection Lakes"}
    if(unique(substr(trailyear,1,2))=="GB"){trails <- "Glacier Basin"}
  }
 
  #Save parameters to appropriate file
  #first, intercept and slope coefficients
  tmppeakpars <- c(species[i],modelsnowmod$par[1:2])
  pars_spp_peak <- rbind(pars_spp_peak,tmppeakpars)
  
  #intercept and slope of simple lm
  tmpparscor <- c(species[i], unlist(coef(lmtest)))
  pars_cor <- rbind(pars_cor, tmpparscor)
  
  #save AIC
  tmpaic <- c(species[i],round(2*(modelsnowmod$value+length(param)),2))
  aics_sp <- rbind(aics_sp,tmpaic)
  
  #now range and max pars
  if(trails=="Reflection Lakes"){
    #range parameters
    tmpspp <- rep(species[i], times=ntrlyr)
    tmpsite <- rep("RL", times=ntrlyr)
    tmpyear <- yrs
    tmprange <- modelsnowmod$par[3:(2+ntrlyr)]
    tmprangepars <- cbind(tmpspp,tmpsite,tmpyear,tmprange)
    pars_spp_range <- rbind(pars_spp_range,tmprangepars)
      
    #max parameters
    tmpmax <- modelsnowmod$par[(3+ntrlyr):(2+ntrlyr+ntrlyr)]
    tmpmaxpars <- cbind(tmpspp,tmpsite,tmpyear,tmpmax)
    pars_spp_max <- rbind(pars_spp_max,tmpmaxpars)
  }
  
  if(trails=="Glacier Basin"){
    #range parameters
    tmpspp <- rep(species[i], times=ntrlyr)
    tmpsite <- rep("GB", times=ntrlyr)
    tmpyear <- substr(trailyear,3,6)
    tmprange <- modelsnowmod$par[3:(2+ntrlyr)]
    tmprangepars <- cbind(tmpspp,tmpsite,tmpyear,tmprange)
    pars_spp_range <- rbind(pars_spp_range,tmprangepars)
      
    #max parameters
    tmpmax <- modelsnowmod$par[(3+ntrlyr):(2+ntrlyr+ntrlyr)]
    tmpmaxpars <- cbind(tmpspp,tmpsite,tmpyear,tmpmax)
    pars_spp_max <- rbind(pars_spp_max,tmpmaxpars)
  }
  
  if(trails=="both"){
    #range parameters
    tmpspp <- rep(species[i], times=ntrlyr)
    tmpsite <- substr(trailyear,1,2)
    tmpyear <- substr(trailyear,3,6)
    tmprange <- modelsnowmod$par[3:(2+ntrlyr)]
    tmprangepars <- cbind(tmpspp,tmpsite,tmpyear,tmprange)
    pars_spp_range <- rbind(pars_spp_range,tmprangepars)
      
    #max parameters
    tmpmax <- modelsnowmod$par[(3+ntrlyr):(2+ntrlyr+ntrlyr)]
    tmpmaxpars <- cbind(tmpspp,tmpsite,tmpyear,tmpmax)
    pars_spp_max <- rbind(pars_spp_max,tmpmaxpars)
  }
}

#make par_spp_peak, pars_spp_range, and pars_spp_max, data frames
dimnames(pars_spp_peak) <- list(c(), c("species","peakint", "peakSDDslope"))
dimnames(pars_spp_range) <- list(c(), c("species","site", "year","range"))
dimnames(pars_spp_max) <- list(c(), c("species","site", "year","max"))
dimnames(aics_sp) <- list(c(), c("species","AIC"))
dimnames(pars_cor) <- list(c(), c("species","intercept","slope"))

#Change to data frame
pars_spp_peak <- data.frame(pars_spp_peak)
pars_spp_range <- data.frame(pars_spp_range)
pars_spp_max <- data.frame(pars_spp_max)
pars_cor <- data.frame(pars_cor)
aics_sp <- data.frame(aics_sp)

#change storage type 
pars_spp_peak$species <- as.factor(pars_spp_peak$species)
pars_spp_range$species <- as.factor(pars_spp_range$species)
pars_spp_max$species <- as.factor(pars_spp_max$species)
pars_cor$species <- as.factor(pars_cor$species)
pars_spp_range$site <- as.factor(pars_spp_range$site)
pars_spp_max$site <- as.factor(pars_spp_max$site)
aics_sp$species <- as.factor(aics_sp$species)
aics_sp$AIC <- as.numeric(aics_sp$AIC)

for(i in 2:3){
  pars_spp_peak[,i] <- as.numeric(pars_spp_peak[,i])
  pars_cor[,i] <- as.numeric(pars_cor[,i])
  pars_spp_range[,i+1] <- as.numeric(pars_spp_range[,i+1])
  pars_spp_max[,i+1] <- as.numeric(pars_spp_max[,i+1])
}

head(pars_spp_peak)
head(pars_spp_range)
head(pars_spp_max)
head(aics_sp)

#Write fitted parameters
write.csv(pars_spp_peak, "data/PeakSDDRelationship.csv", quote=FALSE,
          row.names=FALSE)
write.csv(pars_spp_range, "data/YearTrailRange.csv", quote=FALSE,
          row.names=FALSE)
write.csv(pars_spp_max, "data/YearTrailMax.csv", quote=FALSE,
          row.names=FALSE)
write.csv(aics_sp, "data/AIC_speciesmodel.csv", quote=FALSE,
          row.names=FALSE)

```


#Calculate AIC species model vs. separate parameters for all plots
Note - this shows that the separate parameters for all plots does better, despite needing a lot more parameters. So we can't use model fit to justify this. A reasonable question would be - how much worse does the all species model do in predicting peak (the main parameter we use), and perhaps round out some oddities.
```{r}
aics_yrpltsp <- read.csv("data/AIC_plotmodel.csv", header = TRUE)
aics_yrpltsp2 <- tapply(aics_yrpltsp$AICalt, aics_yrpltsp$species, sum)
aics_yrpltsp3 <- data.frame(names(aics_yrpltsp2),aics_yrpltsp2)
colnames(aics_yrpltsp3) <- c("species","plotmodel")
rownames(aics_yrpltsp3) <- c()
aics_comp <- merge(aics_sp, aics_yrpltsp3)
dimnames(aics_comp)[[2]][2] <- "snowmodel"
dimnames(aics_comp)[[2]][3] <- "plotmodel"

aics_comp
```

# Show plot-level peak fits vs. fitted coefficients

```{r}

#Read in per plot model fits, so individual plot fits can be used
pars_yrpltsp <- read.csv("data/PerPlotCurves.csv", header=TRUE) 

#extract species
#species <- pars_spp_peak$species
yrcols <- c("green","lightblue","orange","purple","pink","red","grey")

##Plot SDD vs. peak per species
for(i in 1:length(species)){
  sp_pars <- pars_yrpltsp[pars_yrpltsp$species==species[i],]
  yrcolind <- sp_pars$year - 2012
  
  #make a dummy plot to add lines to
  par(mfrow=c(1,1), omi=c(0,0,0,0), mai=c(0.5,0.6,0.5,0.5), 
      tck=-0.02, mgp=c(1.1,0.5,0))
  plot(sp_pars$SDD, sp_pars$peak, pty="s",
       pch=21, bg=yrcols[yrcolind], cex=1.5,
       xlab="Snow Disappearance Date", ylab="Peak Flowering")
  #text(sp_pars$SDD, (sp_pars$peak+tiny), labels=sp_pars$plot, cex=0.5) 
  title(species[i])
  legend(x="topleft", legend=yrs, pt.bg=yrcols, pch=21)
  
  #add line
  intSDD <- pars_spp_peak$peakint[pars_spp_peak$species==species[i]]
  slSDD <- pars_spp_peak$peakSDDslope[pars_spp_peak$species==species[i]]
  abline(intSDD, slSDD)
  abline(0,1, col="lightblue", lty=2, lwd=2)
  
}

```

